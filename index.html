<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ChatKat by Mehedi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007AFF;
            --primary-hover-color: #0056b3;
            --sent-bg-light: linear-gradient(135deg, #007AFF, #005CE6);
            --sent-bg-dark: linear-gradient(135deg, #0b84ff, #2563eb);
            --received-bg-light: #F2F2F7;
            --received-bg-dark: #2c2c2e;
            --bg-main-light: #FFFFFF;
            --bg-main-dark: #121212;
            --bg-light-light: #F5F5F7;
            --bg-light-dark: #1c1c1e;
            --text-dark-light: #1c1c1e;
            --text-dark-dark: #e1e1e1;
            --text-light-light: #ffffff;
            --text-light-dark: #ffffff;
            --text-secondary-light: #8A8A8E;
            --text-secondary-dark: #8d8d92;
            --border-color-light: #E5E5E5;
            --border-color-dark: #3a3a3c;
            --shadow-light: 0 2px 12px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 10px 40px rgba(0, 0, 0, 0.15);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --radius-small: 8px;
            --radius-medium: 12px;
            --radius-large: 20px;
            --transition-fast: 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            --transition-medium: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        [data-theme="dark"] {
            --sent-bg: var(--sent-bg-dark);
            --received-bg: var(--received-bg-dark);
            --bg-main: var(--bg-main-dark);
            --bg-light: var(--bg-light-dark);
            --text-dark: var(--text-dark-dark);
            --text-light: var(--text-light-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-color-dark);
        }

        [data-theme="light"] {
            --sent-bg: var(--sent-bg-light);
            --received-bg: var(--received-bg-light);
            --bg-main: var(--bg-main-light);
            --bg-light: var(--bg-light-light);
            --text-dark: var(--text-dark-light);
            --text-light: var(--text-light-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-color-light);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-dark);
            transition: background-color var(--transition-medium), color var(--transition-medium);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 450px;
            background-color: var(--bg-main);
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            position: relative;
        }
        @media (min-width: 451px) {
            .chat-container { height: 95vh; max-height: 900px; border-radius: 24px; }
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .header-bar {
            display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-color);
            z-index: 10; flex-shrink: 0; background-color: var(--bg-main);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .profile-pic {
            width: 40px; height: 40px; border-radius: 50%; background-color: #ffc107;
            background-size: cover; background-position: center; cursor: pointer;
            transition: all var(--transition-fast); display: flex; justify-content: center;
            align-items: center; font-weight: 600; font-size: 1.1rem; color: var(--text-dark);
            box-shadow: var(--shadow-light); border: 2px solid white;
        }
        .profile-pic:hover { transform: scale(1.05); box-shadow: var(--shadow-medium); }
        .group-info { text-align: left; flex-grow: 1; margin: 0 12px; overflow: hidden; }
        .group-info h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; color: var(--text-dark); }
        .group-info p { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
        
        #theme-toggle { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 8px; border-radius: 50%; transition: all var(--transition-fast);}
        #theme-toggle:hover { background-color: var(--bg-light); color: var(--text-dark); }
        #theme-toggle .icon { width: 22px; height: 22px; }

        .chat-messages {
            flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column;
            scroll-behavior: smooth; background-color: var(--bg-light);
        }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 3px; }
        
        .message-wrapper { display: flex; flex-direction: column; animation: fadeInUp 0.4s ease-out; margin-bottom: 12px; }
        .message-wrapper.sent { align-items: flex-end; }
        .message-wrapper.received { align-items: flex-start; }
        .message-container { display: flex; align-items: flex-end; max-width: 85%; }
        .message-container.sent { flex-direction: row-reverse; }
        
        .sender-profile-pic {
            width: 32px; height: 32px; border-radius: 50%; background-size: cover;
            background-position: center; flex-shrink: 0; margin-right: 8px; display: flex;
            align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 500;
            background-color: #ccc; box-shadow: var(--shadow-light);
        }
        .message-container.sent .sender-profile-pic { margin-right: 0; margin-left: 8px; }
        
        .message-content {
            padding: 12px 16px; font-size: 0.95rem; line-height: 1.4; border-radius: var(--radius-large);
            word-wrap: break-word; min-width: 50px; position: relative; box-shadow: var(--shadow-light);
        }
        .message-content a { color: inherit; text-decoration: underline; }
        .message-content img { max-width: 100%; border-radius: 12px; margin-top: 5px; } /* Style for rendered images */
        .sender-name { font-size: 0.8rem; font-weight: 600; color: var(--primary-color); margin-bottom: 4px; }
        .message-container.sent .message-content { background: var(--sent-bg); color: var(--text-light); border-bottom-right-radius: var(--radius-small); }
        .message-container.received .message-content { background: var(--received-bg); color: var(--text-dark); border-bottom-left-radius: var(--radius-small); }
        
        .message-info {
            font-size: 0.7rem; text-align: right; margin-top: 5px; opacity: 0.8;
            float: right; margin-left: 10px; display: flex; align-items: center;
        }
        .message-info .status-icon { width: 14px; height: 14px; margin-left: 4px; }

        .typing-indicator {
            padding: 8px 16px; color: var(--text-secondary); font-style: italic;
            font-size: 0.85rem; height: 30px; transition: all var(--transition-fast);
        }

        .input-area-wrapper { flex-shrink: 0; background-color: var(--bg-main); border-top: 1px solid var(--border-color); }
        .input-area { padding: 16px; background-color: var(--bg-main); }
        .input-row { display: flex; align-items: center; background-color: var(--bg-light); border-radius: 24px; padding: 8px; box-shadow: var(--shadow-light); transition: all var(--transition-fast); }
        .input-row:focus-within { box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        .input-field { flex-grow: 1; border: none; background: transparent; padding: 8px 12px; font-size: 1rem; outline: none; color: var(--text-dark); }
        
        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none; background-color: transparent; color: var(--text-secondary);
            font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; transition: all var(--transition-fast);
        }
        .icon-btn .icon { width: 20px; height: 20px; }
        .icon-btn:hover { background-color: color-mix(in srgb, var(--text-dark) 5%, transparent); color: var(--text-dark); }
        #send-btn { background-color: var(--primary-color); color: var(--text-light); }
        #send-btn:hover { background-color: var(--primary-hover-color); transform: scale(1.05); }
        #send-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; transform: none; }
        
        .popup-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            padding: 15px; animation: scaleIn 0.3s ease-out;
        }
        .popup-content {
            background: var(--bg-main); padding: 28px; border-radius: 20px;
            box-shadow: var(--shadow-heavy); width: 100%; max-width: 400px;
        }
        .popup-content h2 { font-size: 1.5rem; font-weight: 600; margin-bottom: 24px; text-align: center; color: var(--text-dark); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); }
        .form-group input {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: var(--radius-medium); font-size: 1rem; transition: all var(--transition-fast);
            background-color: var(--bg-light); color: var(--text-dark);
        }
        .form-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        .action-btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary-color);
            color: white; cursor: pointer; font-size: 1rem; font-weight: 600;
            transition: all var(--transition-fast); box-shadow: var(--shadow-light);
        }
        .action-btn:hover { background: var(--primary-hover-color); transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        #file-input { display: none; }
    </style>
</head>
<body>

    <div class="chat-container">
        <div class="header-bar">
            <div id="user-profile-btn" class="profile-pic"></div>
            <div class="group-info">
                <h2>ChatKat by Mehedi</h2>
                <p id="online-status">Connecting...</p>
            </div>
            <button id="theme-toggle" aria-label="Toggle dark mode">
                <svg class="icon" id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                <svg class="icon" id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
            </button>
        </div>
        
        <div class="chat-messages" id="chat-messages"></div>
        
        <div class="input-area-wrapper">
            <div class="typing-indicator" id="typing-indicator"></div>
            <div class="input-area">
                <div class="input-row">
                    <button class="icon-btn" id="attach-btn" aria-label="Attach file">
                         <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" /></svg>
                    </button>
                    <input type="text" class="input-field" id="message-input" placeholder="Type a message...">
                    <button class="icon-btn" id="send-btn" aria-label="Send message">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
                    </button>
                    <input type="file" id="file-input" accept="image/*">
                </div>
            </div>
        </div>
    </div>

    <div id="create-account-screen" class="popup-overlay" style="display: flex;">
        <div class="popup-content">
            <h2>Create Your Profile</h2>
            <div class="form-group">
                <label for="name-input">Display Name</label>
                <input type="text" id="name-input" placeholder="e.g., Alex Doe" required>
            </div>
            <div class="form-group">
                <label for="profile-pic-url">Profile Picture URL (Optional)</label>
                <input type="text" id="profile-pic-url" placeholder="Paste image URL here">
            </div>
            <button id="save-profile-btn" class="action-btn">Save and Join Chat</button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> <script>
        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                // MODIFIED: Replaced with your new Firebase config
                firebaseConfig: {
                    apiKey: "AIzaSyDpHzYZOY820dxclxaaM1uroNarSjODcwA",
                    authDomain: "chatkat-1f3c5.firebaseapp.com",
                    databaseURL: "https://chatkat-1f3c5-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "chatkat-1f3c5",
                    storageBucket: "chatkat-1f3c5.firebasestorage.app",
                    messagingSenderId: "582784718117",
                    appId: "1:582784718117:web:2f8e075f65c769a47bb6cc",
                    measurementId: "G-YF6FFXJ11Y"
                },
                
                user: { name: '', pic: '', sessionId: '' },
                typingTimeout: null,
                isTyping: false,
                onlineUsers: new Map(),

                elements: {
                    chatMessages: document.getElementById('chat-messages'),
                    messageInput: document.getElementById('message-input'),
                    sendBtn: document.getElementById('send-btn'),
                    attachBtn: document.getElementById('attach-btn'),
                    fileInput: document.getElementById('file-input'),
                    userProfileBtn: document.getElementById('user-profile-btn'),
                    createAccountScreen: document.getElementById('create-account-screen'),
                    saveProfileBtn: document.getElementById('save-profile-btn'),
                    nameInput: document.getElementById('name-input'),
                    profilePicUrlInput: document.getElementById('profile-pic-url'),
                    onlineStatus: document.getElementById('online-status'),
                    typingIndicator: document.getElementById('typing-indicator'),
                    themeToggle: document.getElementById('theme-toggle'),
                    themeIconLight: document.getElementById('theme-icon-light'),
                    themeIconDark: document.getElementById('theme-icon-dark'),
                },

                icons: {
                    sent: `<svg class="status-icon" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`,
                    delivered: `<svg class="status-icon" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                },
                
                init() {
                    this.initTheme();
                    this.initFirebase();
                    this.initEventListeners();
                    this.loadUserProfile();
                    this.toggleSendButton();
                },

                initFirebase() {
                    try {
                        // IMPORTANT: For this app to work, you MUST set up your Firebase Security Rules
                        // for both Realtime Database and Storage to allow public read/write.
                        // Example rule for testing (NOT FOR PRODUCTION): 
                        // { "rules": { ".read": true, ".write": true } }

                        firebase.initializeApp(this.firebaseConfig);
                        this.db = firebase.database();
                        this.storage = firebase.storage(); // NEW: Initialize storage
                        
                        this.initializeDatabaseStructure();
                        
                    } catch (error) {
                        console.error('Firebase initialization failed:', error);
                    }
                },

                initializeDatabaseStructure() {
                    const baseRef = this.db.ref('chatkat_main_chat'); // MODIFIED: Database path
                    
                    baseRef.once('value').then((snapshot) => {
                        if (!snapshot.exists()) {
                            console.log('Creating new database structure...');
                            
                            const initialData = {
                                created_at: firebase.database.ServerValue.TIMESTAMP,
                                name: "ChatKat by Mehedi", // MODIFIED: Chat name
                                description: "Public chat group by Mehedi",
                                messages: {
                                    welcome: {
                                        sender: { name: "System", pic: "" },
                                        sessionId: "system",
                                        text: "Welcome to ChatKat! Start the conversation.",
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    }
                                },
                                presence: {},
                                typing: {},
                            };
                            
                            baseRef.set(initialData).then(() => {
                                console.log('Database structure created successfully!');
                                this.setupFirebaseReferences();
                            }).catch((error) => console.error('Error creating database structure:', error));
                            
                        } else {
                            console.log('Database structure already exists');
                            this.setupFirebaseReferences();
                        }
                    }).catch((error) => console.error('Error checking database structure:', error));
                },

                setupFirebaseReferences() {
                    this.baseRef = this.db.ref('chatkat_main_chat'); // MODIFIED: Database path
                    this.messagesQuery = this.baseRef.child('messages').limitToLast(100);
                    this.presenceRef = this.baseRef.child('presence');
                    this.typingRef = this.baseRef.child('typing');
                    
                    if (this.user.name) {
                        this.startApp();
                    }
                },
                
                initEventListeners() {
                    this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                    this.elements.messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') this.sendMessage(); });
                    this.elements.messageInput.addEventListener('input', () => this.handleTyping());
                    this.elements.attachBtn.addEventListener('click', () => this.elements.fileInput.click());
                    this.elements.saveProfileBtn.addEventListener('click', () => this.saveUserProfile());
                    this.elements.userProfileBtn.addEventListener('click', () => { this.elements.createAccountScreen.style.display = 'flex'; });
                    this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
                    
                    // NEW: Event listener for file selection
                    this.elements.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                },

                loadUserProfile() {
                    this.user.sessionId = localStorage.getItem('sessionId') || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem('sessionId', this.user.sessionId);
                    
                    const savedName = localStorage.getItem('userName');
                    if (savedName) {
                        this.user.name = savedName;
                        this.user.pic = localStorage.getItem('profilePic') || '';
                        this.elements.createAccountScreen.style.display = 'none';
                        this.updateProfileUI();
                        
                        if (this.messagesQuery) {
                            this.startApp();
                        }
                    }
                },

                saveUserProfile() {
                    const name = this.elements.nameInput?.value.trim() || '';
                    if (!name) {
                        alert('Please enter your name');
                        return;
                    }
                    this.user.name = name;
                    this.user.pic = this.elements.profilePicUrlInput?.value.trim() || '';
                    localStorage.setItem('userName', this.user.name);
                    localStorage.setItem('profilePic', this.user.pic);
                    this.elements.createAccountScreen.style.display = 'none';
                    this.updateProfileUI();
                    
                    if (this.messagesQuery) {
                        this.startApp();
                    } else {
                        // If firebase isn't ready, it will be started once references are set up
                        console.log("Profile saved. Waiting for Firebase connection to start app.");
                    }
                },
                
                updateProfileUI() {
                    if (this.user.pic) {
                        this.elements.userProfileBtn.style.backgroundImage = `url(${this.user.pic})`;
                        this.elements.userProfileBtn.textContent = '';
                    } else {
                        this.elements.userProfileBtn.style.backgroundImage = '';
                        this.elements.userProfileBtn.textContent = (this.user.name?.charAt(0) || 'U').toUpperCase();
                    }
                },

                startApp() {
                    if (!this.db || !this.messagesQuery) {
                        console.error('Firebase not properly initialized');
                        return;
                    }
                    this.listenForMessages();
                    this.setupPresence();
                    this.listenForTyping();
                },
                
                // MODIFIED: Accepts an optional text argument for sending image URLs
                sendMessage(textToSend = null) {
                    const text = textToSend || this.elements.messageInput.value.trim();
                    if (!text || !this.messagesQuery) return;
                    
                    const messageData = {
                        sender: { name: this.user.name, pic: this.user.pic },
                        sessionId: this.user.sessionId,
                        text: text,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    this.messagesQuery.ref.push(messageData)
                        .catch((error) => console.error('Error sending message:', error));
                    
                    if (!textToSend) { // Clear input only if it was a user-typed message
                        this.elements.messageInput.value = '';
                    }
                    
                    this.toggleSendButton();
                    this.setTypingStatus(false);
                },

                // NEW: Handle file upload logic
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file || !file.type.startsWith('image/')) {
                        alert('Please select an image file.');
                        return;
                    }
                    
                    this.elements.typingIndicator.textContent = 'Uploading image...';
                    const filePath = `chat_images/${Date.now()}_${file.name}`;
                    const storageRef = this.storage.ref(filePath);
                    
                    storageRef.put(file).then(snapshot => {
                        return snapshot.ref.getDownloadURL();
                    }).then(url => {
                        this.sendMessage(url); // Send the image URL as a message
                        this.elements.typingIndicator.textContent = '';
                    }).catch(error => {
                        console.error('Error uploading file:', error);
                        this.elements.typingIndicator.textContent = 'Upload failed.';
                        alert('Sorry, the image could not be uploaded.');
                    });

                    event.target.value = ''; // Reset file input
                },

                listenForMessages() {
                    const onMessage = snapshot => {
                        const msg = snapshot.val();
                        if (msg && msg.sender) this.renderMessage(msg, snapshot.key);
                    };
                    this.messagesQuery.on('child_added', onMessage);
                    this.messagesQuery.on('child_changed', onMessage);
                },
                
                // MODIFIED: Now renders images if a message is an image URL
                renderMessage(msg, key) {
                    const isSent = msg.sessionId === this.user.sessionId;
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                    
                    const senderPicHtml = !isSent ? `<div class="sender-profile-pic" style="background-image: url('${msg.sender.pic || ''}')">${!msg.sender.pic ? (msg.sender.name?.charAt(0) || 'U').toUpperCase() : ''}</div>` : '';
                    const senderNameHtml = !isSent ? `<div class="sender-name">${msg.sender.name || 'Unknown'}</div>` : '';
                    
                    const statusIcon = isSent ? (this.onlineUsers.size > 1 ? this.icons.delivered : this.icons.sent) : '';

                    // NEW: Check if the message text is an image URL
                    const imageRegex = /^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))$/i;
                    let messageContentHtml;
                    if (imageRegex.test(msg.text)) {
                        messageContentHtml = `<a href="${msg.text}" target="_blank" rel="noopener noreferrer"><img src="${msg.text}" alt="User content"></a>`;
                    } else {
                        // Autolink regular URLs
                        const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                        messageContentHtml = (msg.text || '').replace(urlPattern, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
                    }

                    const wrapper = document.createElement('div');
                    wrapper.id = key;
                    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
                    wrapper.innerHTML = `
                        <div class="message-container ${isSent ? 'sent' : 'received'}">
                            ${senderPicHtml}
                            <div class="message-content">
                                ${senderNameHtml}
                                ${messageContentHtml}
                                <div class="message-info">${time} ${statusIcon}</div>
                            </div>
                        </div>`;
                    
                    const existing = document.getElementById(key);
                    if (existing) {
                        existing.replaceWith(wrapper);
                    } else {
                        this.elements.chatMessages.appendChild(wrapper);
                    }
                    
                    this.scrollToBottom();
                },

                setupPresence() {
                    const myPresenceRef = this.presenceRef.child(this.user.sessionId);
                    const connectedRef = this.db.ref('.info/connected');
                    connectedRef.on('value', snap => {
                        if (snap.val() === true) {
                            myPresenceRef.set({ name: this.user.name, last_seen: firebase.database.ServerValue.TIMESTAMP });
                            myPresenceRef.onDisconnect().remove();
                        }
                    });

                    this.presenceRef.on('value', snap => {
                        this.onlineUsers.clear();
                        if (snap.exists()) {
                            snap.forEach(child => { this.onlineUsers.set(child.key, child.val().name); });
                        }
                        this.updateOnlineStatus();
                    });
                },

                updateOnlineStatus() {
                    const count = this.onlineUsers.size;
                    this.elements.onlineStatus.textContent = count > 0 ? `${count} user${count > 1 ? 's' : ''} online` : 'Offline';
                },

                handleTyping() {
                    this.toggleSendButton();
                    clearTimeout(this.typingTimeout);
                    if (!this.isTyping) this.setTypingStatus(true);
                    this.typingTimeout = setTimeout(() => this.setTypingStatus(false), 2000);
                },

                setTypingStatus(isTyping) {
                    this.isTyping = isTyping;
                    const myTypingRef = this.typingRef.child(this.user.sessionId);
                    if (isTyping) {
                        myTypingRef.set({ name: this.user.name });
                        myTypingRef.onDisconnect().remove();
                    } else {
                        myTypingRef.remove();
                    }
                },

                listenForTyping() {
                    this.typingRef.on('value', snap => {
                        const typingUsers = [];
                        if (snap.exists()) {
                            snap.forEach(child => {
                                if (child.key !== this.user.sessionId) typingUsers.push(child.val().name);
                            });
                        }
                        this.updateTypingIndicator(typingUsers);
                    });
                },
                
                updateTypingIndicator(users) {
                    if (users.length === 0) {
                        this.elements.typingIndicator.textContent = '';
                    } else if (users.length === 1) {
                        this.elements.typingIndicator.textContent = `${users[0]} is typing...`;
                    } else if (users.length === 2) {
                        this.elements.typingIndicator.textContent = `${users[0]} and ${users[1]} are typing...`;
                    } else {
                        this.elements.typingIndicator.textContent = 'Several people are typing...';
                    }
                },

                toggleSendButton() {
                    this.elements.sendBtn.disabled = this.elements.messageInput.value.trim().length === 0;
                },

                scrollToBottom() {
                    setTimeout(() => {
                        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                    }, 100);
                },

                initTheme() {
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    this.setTheme(savedTheme);
                },

                setTheme(theme) {
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    if (theme === 'dark') {
                        this.elements.themeIconLight.style.display = 'none';
                        this.elements.themeIconDark.style.display = 'block';
                    } else {
                        this.elements.themeIconLight.style.display = 'block';
                        this.elements.themeIconDark.style.display = 'none';
                    }
                },

                toggleTheme() {
                    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                },
            };

            App.init();
        });
    </script>
</body>
</html>
